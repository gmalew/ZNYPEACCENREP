sap.ui.define([                                                                                                                                                                                                                                                
    "nype/ft/ac/controller/BaseController",                                                                                                                                                                                                                    
    "sap/ui/model/json/JSONModel",                                                                                                                                                                                                                             
    "sap/ui/core/format/DateFormat"                                                                                                                                                                                                                            
], function (BaseController, JSONModel, DateFormat) {                                                                                                                                                                                                          
    "use strict";                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    return BaseController.extend("nype.ft.ac.controller.Systems", {                                                                                                                                                                                            
        onInit: function () {                                                                                                                                                                                                                                  
            var oViewModel = new JSONModel({                                                                                                                                                                                                                   
                semanticAction: null,                                                                                                                                                                                                                          
                semanticObject: null,                                                                                                                                                                                                                          
                system: null                                                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
            this.setModel(oViewModel, "view");                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            var oRouter = this.getRouter();                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
            oRouter.getRoute("systems").attachMatched(this._onExactRouteMatched, this);                                                                                                                                                                        
            oRouter.getRoute("detail").attachMatched(this._onObjectMatched, this);                                                                                                                                                                             
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onDataReceived: function () {                                                                                                                                                                                                                          
            this._updateListSelection();                                                                                                                                                                                                                       
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onSelectionChange: function (oEvent) {                                                                                                                                                                                                                 
            var oViewModel = this.getModel("view");                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            var oListItem = oEvent.getParameter("listItem");                                                                                                                                                                                                   
            var oObject = oListItem.getBindingContext().getObject();                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
            var sSemanticObject = oViewModel.getProperty("/semanticObject");                                                                                                                                                                                   
            var sSemanticAction = oViewModel.getProperty("/semanticAction");                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
            this.getRouter().navTo("detail", {                                                                                                                                                                                                                 
                semanticObject: encodeURIComponent(sSemanticObject),                                                                                                                                                                                           
                semanticAction: encodeURIComponent(sSemanticAction),                                                                                                                                                                                           
                system: oObject.Sid                                                                                                                                                                                                                            
            }, true);                                                                                                                                                                                                                                          
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        lastUpdateFormatter: function (oDate, bIsAvailable, bDownloadStatus, sSid, oSystems) {                                                                                                                                                                 
            if (!oDate || !bIsAvailable || !bDownloadStatus) {                                                                                                                                                                                                 
                return "";                                                                                                                                                                                                                                     
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            if (sSid in oSystems && oSystems[sSid].dataReceived) {                                                                                                                                                                                             
                return "";                                                                                                                                                                                                                                     
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            return DateFormat.getDateTimeInstance({                                                                                                                                                                                                            
                style: "medium"                                                                                                                                                                                                                                
            }).format(oDate);                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        _onExactRouteMatched: function (oEvent) {                                                                                                                                                                                                              
            this._onObjectMatched(oEvent);                                                                                                                                                                                                                     
            this.getOwnerComponent().setApplicationLayout(0);                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        _onObjectMatched: function (oEvent) {                                                                                                                                                                                                                  
            var oViewModel = this.getModel("view");                                                                                                                                                                                                            
            var oArguments = oEvent.getParameter("arguments");                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            var sSemanticObject = decodeURIComponent(oArguments.semanticObject);                                                                                                                                                                               
            var sSemanticAction = decodeURIComponent(oArguments.semanticAction);                                                                                                                                                                               
            var sSystem = oArguments.system;                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
            oViewModel.setProperty("/semanticObject", sSemanticObject);                                                                                                                                                                                        
            oViewModel.setProperty("/semanticAction", sSemanticAction);                                                                                                                                                                                        
            oViewModel.setProperty("/system", sSystem);                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
            this._updateListSelection();                                                                                                                                                                                                                       
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        _updateListSelection: function () {                                                                                                                                                                                                                    
            var oList = this.byId("systems");                                                                                                                                                                                                                  
            var sSystem = this.getModel("view").getProperty("/system");                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
            oList.getItems().forEach(function (oItem) {                                                                                                                                                                                                        
                var oObject = oItem.getBindingContext().getObject();                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                oList.setSelectedItem(oItem, oObject.Sid === sSystem);                                                                                                                                                                                         
            });                                                                                                                                                                                                                                                
        }                                                                                                                                                                                                                                                      
    });                                                                                                                                                                                                                                                        
});                                                                                                                                                                                                                                                            