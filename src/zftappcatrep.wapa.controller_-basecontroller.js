sap.ui.define([                                                                                                                                                                                                                                                
    "sap/ui/core/mvc/Controller",                                                                                                                                                                                                                              
    "sap/m/MessageBox"                                                                                                                                                                                                                                         
], function (Controller, MessageBox) {                                                                                                                                                                                                                         
    "use strict";                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    return Controller.extend("nype.ft.ac.baseController.BaseController", {                                                                                                                                                                                     
        /**                                                                                                                                                                                                                                                    
         * Convenience method for accessing the router.                                                                                                                                                                                                        
         * @public                                                                                                                                                                                                                                             
         * @returns {sap.ui.core.routing.Router} the router for this component                                                                                                                                                                                 
         */                                                                                                                                                                                                                                                    
        getRouter: function () {                                                                                                                                                                                                                               
            return sap.ui.core.UIComponent.getRouterFor(this);                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /**                                                                                                                                                                                                                                                    
         * Convenience method for getting the view model by name.                                                                                                                                                                                              
         * @public                                                                                                                                                                                                                                             
         * @param {string} [sName] the model name                                                                                                                                                                                                              
         * @returns {sap.ui.model.Model} the model instance                                                                                                                                                                                                    
         */                                                                                                                                                                                                                                                    
        getModel: function (sName) {                                                                                                                                                                                                                           
            var oModel = this.getView().getModel(sName);                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
            if (oModel) {                                                                                                                                                                                                                                      
                return oModel;                                                                                                                                                                                                                                 
            } else {                                                                                                                                                                                                                                           
                return this.getOwnerComponent().getModel(sName);                                                                                                                                                                                               
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /**                                                                                                                                                                                                                                                    
         * Convenience method for setting the view model.                                                                                                                                                                                                      
         * @public                                                                                                                                                                                                                                             
         * @param {sap.ui.model.Model} oModel the model instance                                                                                                                                                                                               
         * @param {string} sName the model name                                                                                                                                                                                                                
         * @returns {sap.ui.mvc.View} the view instance                                                                                                                                                                                                        
         */                                                                                                                                                                                                                                                    
        setModel: function (oModel, sName) {                                                                                                                                                                                                                   
            return this.getView().setModel(oModel, sName);                                                                                                                                                                                                     
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /**                                                                                                                                                                                                                                                    
         * Getter for the resource bundle.                                                                                                                                                                                                                     
         * @public                                                                                                                                                                                                                                             
         * @returns {sap.ui.model.resource.ResourceModel} the resourceModel of the component                                                                                                                                                                   
         */                                                                                                                                                                                                                                                    
        getResourceBundle: function () {                                                                                                                                                                                                                       
            return this.getOwnerComponent().getModel("i18n").getResourceBundle();                                                                                                                                                                              
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /**                                                                                                                                                                                                                                                    
         * Getter for the text from i18n bundle.                                                                                                                                                                                                               
         * @public                                                                                                                                                                                                                                             
         * @param {string} [sName] the text name                                                                                                                                                                                                               
         * @param {array} [aArguments] the arguments for text                                                                                                                                                                                                  
         * @returns {string} the formatted text from i18n bundle                                                                                                                                                                                               
         */                                                                                                                                                                                                                                                    
        getText: function (sName, aArguments) {                                                                                                                                                                                                                
            return this.getResourceBundle().getText(sName, aArguments);                                                                                                                                                                                        
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /**                                                                                                                                                                                                                                                    
         * Send OData read request                                                                                                                                                                                                                             
         * @public                                                                                                                                                                                                                                             
         * @param {string} [sCollectionName] OData collection name                                                                                                                                                                                             
         * @param {object} [oParameters] Additional parameters:                                                                                                                                                                                                
         *        {boolean} [forceSendRequest] if false request will not be send if data already is in model                                                                                                                                                   
         *        {array} [filters] Request filters                                                                                                                                                                                                            
         *        {array} [sorters] Request sorters                                                                                                                                                                                                            
         *        {array} [expand] Request expand                                                                                                                                                                                                              
         *        {array} [urlParameters] Request urlParameters                                                                                                                                                                                                
         *        {object} [oDataModel] ODataModel                                                                                                                                                                                                             
         * @returns {Promise} Request promise                                                                                                                                                                                                                  
         */                                                                                                                                                                                                                                                    
        readEntitySet: function (sCollectionName, oParameters) {                                                                                                                                                                                               
            if (!oParameters) {                                                                                                                                                                                                                                
                oParameters = {};                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            var oDataModel = oParameters.oDataModel || this.getModel();                                                                                                                                                                                        
            var aFilters = oParameters.filters;                                                                                                                                                                                                                
            var aSorters = oParameters.sorters;                                                                                                                                                                                                                
            var aExpand = oParameters.expand;                                                                                                                                                                                                                  
            var oUrlParameters = oParameters.urlParameters;                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
            var bForceSendRequest = oParameters.forceSendRequest;                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            if (aFilters || aSorters || aExpand) {                                                                                                                                                                                                             
                bForceSendRequest = true;                                                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            return new Promise(function (fnResolve, fnReject) {                                                                                                                                                                                                
                oDataModel.metadataLoaded().then(function () {                                                                                                                                                                                                 
                    if (aExpand) {                                                                                                                                                                                                                             
                        if (!oUrlParameters) {                                                                                                                                                                                                                 
                            oUrlParameters = {};                                                                                                                                                                                                               
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        oUrlParameters.$expand = aExpand.join();                                                                                                                                                                                               
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    var sCollectionPath = "/" + sCollectionName;                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                    if (!bForceSendRequest) {                                                                                                                                                                                                                  
                        var oLocalData = oDataModel.getData(sCollectionPath);                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                        if (oLocalData) {                                                                                                                                                                                                                      
                            fnResolve(oLocalData);                                                                                                                                                                                                             
                            return;                                                                                                                                                                                                                            
                        }                                                                                                                                                                                                                                      
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    oDataModel.read(sCollectionPath, {                                                                                                                                                                                                         
                        success: fnResolve,                                                                                                                                                                                                                    
                        error: fnReject,                                                                                                                                                                                                                       
                        filters: aFilters,                                                                                                                                                                                                                     
                        sorters: aSorters,                                                                                                                                                                                                                     
                        urlParameters: oUrlParameters                                                                                                                                                                                                          
                    });                                                                                                                                                                                                                                        
                });                                                                                                                                                                                                                                            
            });                                                                                                                                                                                                                                                
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /**                                                                                                                                                                                                                                                    
         * Send OData read request                                                                                                                                                                                                                             
         * @public                                                                                                                                                                                                                                             
         * @param {string} [sCollectionName] OData collection name                                                                                                                                                                                             
         * @param {string} [oKey] OData collection key                                                                                                                                                                                                         
         * @param {object} [oParameters] Additional parameters:                                                                                                                                                                                                
         *        {boolean} [forceSendRequest] if false request will not be send if data already is in model                                                                                                                                                   
         *        {array} [expand] Request expand                                                                                                                                                                                                              
         *        {array} [urlParameters] Request urlParameters                                                                                                                                                                                                
         *        {object} [oDataModel] ODataModel                                                                                                                                                                                                             
         * @returns {Promise} Request promise                                                                                                                                                                                                                  
         */                                                                                                                                                                                                                                                    
        readEntity: function (sCollectionName, oKey, oParameters) {                                                                                                                                                                                            
            if (!oParameters) {                                                                                                                                                                                                                                
                oParameters = {};                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            var oDataModel = oParameters.oDataModel || this.getModel();                                                                                                                                                                                        
            var aExpand = oParameters.expand;                                                                                                                                                                                                                  
            var oUrlParameters = oParameters.urlParameters;                                                                                                                                                                                                    
            var bForceSendRequest = oParameters.forceSendRequest;                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            return new Promise(function (fnResolve, fnReject) {                                                                                                                                                                                                
                oDataModel.metadataLoaded().then(function () {                                                                                                                                                                                                 
                    if (aExpand) {                                                                                                                                                                                                                             
                        if (!oUrlParameters) {                                                                                                                                                                                                                 
                            oUrlParameters = {};                                                                                                                                                                                                               
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        oUrlParameters.$expand = aExpand.join();                                                                                                                                                                                               
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    var sCollectionPath = "/" + oDataModel.createKey(sCollectionName, oKey);                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                    if (!bForceSendRequest) {                                                                                                                                                                                                                  
                        var oLocalData = oDataModel.getData(sCollectionPath);                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                        if (oLocalData) {                                                                                                                                                                                                                      
                            fnResolve(oLocalData);                                                                                                                                                                                                             
                            return;                                                                                                                                                                                                                            
                        }                                                                                                                                                                                                                                      
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    oDataModel.read(sCollectionPath, {                                                                                                                                                                                                         
                        success: fnResolve,                                                                                                                                                                                                                    
                        error: fnReject,                                                                                                                                                                                                                       
                        urlParameters: oUrlParameters                                                                                                                                                                                                          
                    });                                                                                                                                                                                                                                        
                });                                                                                                                                                                                                                                            
            });                                                                                                                                                                                                                                                
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        /**                                                                                                                                                                                                                                                    
         * Export from url                                                                                                                                                                                                                                     
         * @param {String} sUrl Export source url                                                                                                                                                                                                              
         */                                                                                                                                                                                                                                                    
        exportFromUrl: function (sUrl) {                                                                                                                                                                                                                       
            var oElement = window.document.createElement('a');                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            oElement.setAttribute("href", sUrl);                                                                                                                                                                                                               
            oElement.style.display = "none";                                                                                                                                                                                                                   
            document.body.appendChild(oElement);                                                                                                                                                                                                               
            oElement.click();                                                                                                                                                                                                                                  
            document.body.removeChild(oElement);                                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        dateFormatter: function (oDate) {                                                                                                                                                                                                                      
            if (oDate) {                                                                                                                                                                                                                                       
                return DateFormat.getDateInstance({                                                                                                                                                                                                            
                    style: "medium"                                                                                                                                                                                                                            
                }).format(oDate);                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            return "";                                                                                                                                                                                                                                         
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        showDiscardUnsavedChangesDialog: function () {                                                                                                                                                                                                         
            var oModel = this.getModel();                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
            if (oModel.hasPendingChanges()) {                                                                                                                                                                                                                  
                var sTitle = this.getText("common.unsavedChanges.title");                                                                                                                                                                                      
                var sText = this.getText("common.unsavedChanges.text");                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                return new Promise(function (fnResolve) {                                                                                                                                                                                                      
                    MessageBox.warning(sText, {                                                                                                                                                                                                                
                        title: sTitle,                                                                                                                                                                                                                         
                        actions: [sap.m.MessageBox.Action.YES, sap.m.MessageBox.Action.NO],                                                                                                                                                                    
                        onClose: function (sAction) {                                                                                                                                                                                                          
                            if (sAction === sap.m.MessageBox.Action.YES) {                                                                                                                                                                                     
                                oModel.resetChanges();                                                                                                                                                                                                         
                                fnResolve(true);                                                                                                                                                                                                               
                            } else {                                                                                                                                                                                                                           
                                fnResolve(false);                                                                                                                                                                                                              
                            }                                                                                                                                                                                                                                  
                        }                                                                                                                                                                                                                                      
                    });                                                                                                                                                                                                                                        
                });                                                                                                                                                                                                                                            
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            return Promise.resolve(true);                                                                                                                                                                                                                      
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        saveChanges: function () {                                                                                                                                                                                                                             
            var oViewModel = this.getModel("view");                                                                                                                                                                                                            
            var oModel = this.getModel();                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
            if (oModel.hasPendingChanges()) {                                                                                                                                                                                                                  
                oViewModel.setProperty("/busy", true);                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                oModel.submitChanges({                                                                                                                                                                                                                         
                    success: function (oData) {                                                                                                                                                                                                                
                        oViewModel.setProperty("/busy", false);                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                        this._handleSubmitChanges(oData.__batchResponses);                                                                                                                                                                                     
                    }.bind(this),                                                                                                                                                                                                                              
                    error: function () {                                                                                                                                                                                                                       
                        oViewModel.setProperty("/busy", false);                                                                                                                                                                                                
                    }                                                                                                                                                                                                                                          
                });                                                                                                                                                                                                                                            
            } else {                                                                                                                                                                                                                                           
                this._navBack(false);                                                                                                                                                                                                                          
            }                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        _handleSubmitChanges: function (aResponses) {                                                                                                                                                                                                          
            for (var i = 0; i < aResponses.length; i++) {                                                                                                                                                                                                      
                var oResponse = this._getResponseErrorMessage(aResponses[i].response);                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                if (oResponse) {                                                                                                                                                                                                                               
                    MessageBox.error(oResponse.value);                                                                                                                                                                                                         
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            // navigate back only if there was no error                                                                                                                                                                                                        
            this._navBack(true);                                                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        _getResponseErrorMessage: function (oResponse) {                                                                                                                                                                                                       
            if (oResponse && oResponse.body) {                                                                                                                                                                                                                 
                var oResponseObject;                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                try {                                                                                                                                                                                                                                          
                    oResponseObject = JSON.parse(oResponse.body);                                                                                                                                                                                              
                } catch (oError) {                                                                                                                                                                                                                             
                    console.error(oError);                                                                                                                                                                                                                     
                    return null;                                                                                                                                                                                                                               
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                if (oResponseObject.error && oResponseObject.error.innererror && oResponseObject.error.innererror.errordetails && oResponseObject.error.innererror.errordetails.length > 0) {                                                                  
                    var oErrorDetail = oResponseObject.error.innererror.errordetails[0];                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                    return {                                                                                                                                                                                                                                   
                        value: oErrorDetail.message                                                                                                                                                                                                            
                    }                                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            return null;                                                                                                                                                                                                                                       
        }                                                                                                                                                                                                                                                      
    });                                                                                                                                                                                                                                                        
});                                                                                                                                                                                                                                                            